title: Https简易工作原理
date: 2016/09/20 17:26:50
toc  : true
tags: [Https,加密]
categories: technology
description: 一篇关于Https原理的文章，语言精炼，通俗易懂

---

最近在看到这么一篇讲解Https原理的文章，语言精炼，通俗易懂，特地将其翻译下，原文在此[how does https work][1]

# 加密算法简介

正文开始之前，我先来解释简单的解释下对称加密和非对称加密.

>**对称加密**采用对称密码编码技术，也就是编码和解码采用相同描述字符，即加密和解密使用相同的密钥，实现这种加密技术的算法称对称加密算法。对称加密使用简单，密钥较短，加密和解密过程较快，耗时短，常见的对称加密算法有DES，3DES，lDEA，AES，RC4等。

>**非对称加密**与对称加密不同，其加密算法需要两个密钥：公开密钥（publickey）和私有密钥（private），两者是一对的。如果用公钥加密，只能用私钥才能解密。非对称加密保密性好，但加密和解密花费的时间较长，不适合对大文件加密而只适合对少量的数据加密。常见的非对称加密算法有RSA，ECC，DSA(数字签名)等。

>**Hash算法**是一种单向算法，通过Hash算法可以对目标数据生成一段特定长度、唯一的hash值,但是不能通过这个hash值重新计算出原始的数据，因此也称之为摘要算法，经常被用在不需要数据还原的密码加密以及数据完整性校验上，常用的算法有MD2，MD4，MD5，SHA等。

现在我们对对称加密，非对称加密及Hash算法做了简单的说明之后，就可以开始了解https的工作原理了。

----------


# https是如何工作的？


这篇文章是我在我团队中分享的。很多人不理解https的好处，不理解https的原理，因此我将这篇文章也分享给大家。


## 加密（Cipher）

在java 1.2时，引入JCR（java 加密扩展）系统，用来负责java中的密钥和证书。

我们都知道，如果我们想要加密或解密一些信息，我们必须要有一个密钥。这好比你想要开门或者锁门，必须要有钥匙一样。

在java中，密钥由KeyGenerator或KeyPairGenerator生成。前者用来生成对称密钥，后者用来生成非对称密钥。

 - 对称密钥：使用同一个密钥进行加密和解密
 - 非对称密钥：使用不同的密钥进行加密和解密，通常被称为公钥（public key）和私钥（private key）。 公钥可以广泛传播，但是私钥只有其所有者知道。在一个安全的非对称密钥加密方案中，当信息用公钥加密后，只有用私钥才能解密。所以，即使一个黑客拿到你公钥加密过后的信息，也无法解密它，因为它没有配对的私钥。这样，传输的消息就是安全的。

## 证书（Certificate）

在现实中，如果你进入到钻石专卖店中想要买一颗钻石，你怎么知道钻石是真的？作为一个普通人来说，我们没有钻石方面的知识，但是如果这钻石有个由美国政府颁发的许可证，我们就会相信它是真的。（去过珠宝店的同学都知道，每件珠宝都有自己的鉴定书）

证书的作用也是如此。在计算机世界中，它可能是包含一些密钥，是另一个证书（姑且称之为证书B好了）。这些密钥是我们需要的，而证书B是一个许可证，用来证明这个证书是可信赖的。

>做个简短的解释，每个钻石都有自己的“身份证书”，但是如何说明这个身份证书是合法的，而不是自己伪造的？因此，我们需要一个权威的机构来证明这个钻石的身份证书是合法的，如果这个钻石的身份是合法的，该权威机构就会为其颁发一个“许可证”，这个许可证就相当于上面我们说到的证书B。可以看到，证书B的目的就是证明这个身份证书是这个钻石的身份证书，即证明某某东西是某某东西的东西

问题来了：我们怎么确定证书B是可信赖的呢？这个问题非常棒。

Android已经把将近150个CA根证书（数字证书认证机构认证过的证书）内置在我们手机中。这150多个证书被全世界信赖，他们就像是美国的大法官。

> 这150多个证书类似我们刚才说的证书B，分别用来证明某某东西是某某东西的东西

B证书中里有另外一个证书（姑且称之为C证书），我们通过检查C来确定C是否是可信任的。。。通过这个证书链，如果我们找到的最后一个或根证书 和手机中预置的150个证书中某个相同，我们就可以这个证书原件（此处就是B）

> 这里我对证书链进行说明。证书之间的信任关系是可以嵌套的。比如，CA信任D，D信任C，C信任B
,B信任A。。。这就是证书链。只要我们信任证书链上的头一个证书，那么后续的证书都是可以信任的。这里也就是如果我信任了证书CA，那么后面的D，C，B，A都是可以信任的。这里来打个比方，架设军队中的每个士兵都只认识自己的直接上级，那么这时候总司令怎么确认某个士兵是自己部队 当中的呢？总司令（CA）会问的直接下级（D），而司令的直接下级又会找自己的直接下级，依次往下找...如果最后能找到这个士兵直属上级，那就说明这个士兵是该部队当中的。



附：证书有多种格式

 - x.509
   x.509证书通常用于包含一个公钥
   
 - PKCS12
    PKCS12证书通常用来包含一个私钥。因此，PKCS12需要密码才能打开。



## Https

现在我们来了解https部分。Https（http over ssl）包含上面提到的加密和证书两部分，被设计用来在Internet安全进行通信。

### 如何安全的通信？
如何安全通信呢？对称加密是我们最先想到的方案：将数据进行加密，然后将加密过的数据和密钥同时传到服务器，服务器使用这个密钥解密加密过后的数据。

![mage-20180708125333](http://pbj0kpudr.bkt.clouddn.com/blog/2018-07-08-image-201807081253332.png)



现在，我们来看看这种可能的场景：黑客截获了该通信，这意味着黑客拥有了密钥和密文。一旦黑客有了密钥，那么解密密文就是很简单的事情了，我们的数据就这样泄漏了。


### 如何使用非对称加密？
上面的解决方案非常不安全。我们继续往下看。使用非对称加密怎么样？

这个想法非常棒：服务端发送给你公钥，你使用这个公钥加密数据。因为服务端是唯一拥有私钥的，
这意味着只有服务端能够解密密文。即使黑客截获了该通讯，但因为没有私钥也就无法解密密文。

但是，非对称加密比对称加密更加耗时。为了用户体验，不建议使用非对称加密这种方式来加密/解密大量的数据
。



### 最终方案
前两种方案都无法解决我们安全通信，我们怎么结合上面的两种方案呢？来看看最终方案：


![ttp](http://pbj0kpudr.bkt.clouddn.com/blog/2018-07-08-https.jpg)

上面这张图片已经清楚的展示了HTTPS工作的流程。

1.[Server]生成一对密钥：公钥和私钥，我们称之为“KeyPub”，“KeyPri”
2.[Server]服务端将公钥（KeyPub）发送到客户端
3.[Client]生成一个对称密钥（姑且称之为key2），然后用key2加密数据。
4.[Client]使用公钥（KeyPub）加密key2.这时，key2是安全的，因为只有服务度有私钥KeyPri
5.[Client]发送用key2加密后的信息及用KeyPub加密过的key2到服务端
6.[Server]服务端使用KeyPri解密得到加密过的key2，得到真正的key2
7.[Server]使用key2解密消息正文。这样，数据就被安全的传输到了服务端。



##结论

由于对称加密比非对称加密快，https决定使用对称加密来加密数据，使用非对称加密对称加密生成的密钥，以确保安全。

这篇文章最后并没有很好的说明证书的作用，因此如果你以前没了解过，到此可能产生一些困惑，后面我会再单独写一篇文章来说明下。




[1]: http://www.songzhw.com/2016/09/13/how-does-https-work/
[2]: http://i2.wp.com/github.com/songzhw/songzhw.github.io/raw/master/imgs/20160113_01.jpg?w=840&amp;amp;amp;ssl=1
[3]: http://i0.wp.com/github.com/songzhw/songzhw.github.io/raw/master/imgs/20160113_02.jpg?w=840&amp;amp;amp;ssl=1
