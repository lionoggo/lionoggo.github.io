<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="猫的故事里有我">
  <meta name="author" content="lionoggo">
  <meta name="keywords" content="">
  <title>JNI开发之RegisterNatives - Floating Cat</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_fmb4a04yx8h.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">




<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


<meta name="generator" content="Hexo 4.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Floating Cat</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">
              <i class="iconfont icon-home-fill"></i>
              首页</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">
              <i class="iconfont icon-archive-fill"></i>
              归档</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">
              <i class="iconfont icon-category-fill"></i>
              分类</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">
              <i class="iconfont icon-tags-fill"></i>
              标签</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">
              <i class="iconfont icon-user-fill"></i>
              关于</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <div class="mt-3 post-meta">
                  <i class="iconfont icon-date-fill" aria-hidden="true"></i>
                  <time datetime="2016-12-20 12:20">
                    2016年12月20日 中午
                  </time>
                </div>
              

              <div class="mt-1">
                
                  
                  <span class="post-meta mr-2">
                    <i class="iconfont icon-chart"></i>
                    2k 字
                  </span>
                

                
                  
                  <span class="post-meta mr-2">
                      <i class="iconfont icon-clock-fill"></i>
                    
                    
                    26
                     分钟
                  </span>
                

                
              </div>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <p>JNI开发流程相对比较固定,一般需要经过以下几步:</p>
<ol>
<li>定义Native方法</li>
<li>生成.h头文件</li>
<li>编写C/C++文件</li>
<li>生成本地链接库</li>
</ol>
<p>这里简单的写一个例子来演示上述流程.</p>
<h1 id="JNI开发流程"><a href="#JNI开发流程" class="headerlink" title="JNI开发流程"></a>JNI开发流程</h1><h2 id="定义Native方法"><a href="#定义Native方法" class="headerlink" title="定义Native方法"></a>定义Native方法</h2><p>为了说明流程,我们直接在根目录中创建Hello.java:</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hello</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title">say</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;
        System.loadLibrary(<span class="hljs-string">"hi"</span>);
        Hello hello = <span class="hljs-keyword">new</span> Hello();
        hello.say();
    &#125;
&#125;</code></pre>

<p>需要注意如果链接库中有多个native方法,只需要一次<code>System.loadLibrary()</code>.链接库在不同的平台中后缀不同:</p>
<ul>
<li><p>window以.dll结尾</p>
</li>
<li><p>macOS以.jnilib结尾</p>
</li>
<li><p>linux中以.so结尾</p>
<p>不要弄错,否则会导致UnsatisfiedLinkError.</p>
</li>
</ul>
<h2 id="javah生成-h头文件"><a href="#javah生成-h头文件" class="headerlink" title="javah生成.h头文件"></a>javah生成.h头文件</h2><p>Java中提供javah命令用于生成.h头文件.这里我们执行<code>javah Hello</code>命令即可生成对应的Hello.h.</p>
<pre><code class="hljs c"><span class="hljs-comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;jni.h&gt;</span></span>
<span class="hljs-comment">/* Header for class Hello */</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> _Included_Hello</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _Included_Hello</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __cplusplus</span>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> &#123;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-comment">/*</span>
<span class="hljs-comment"> * Class:     Hello</span>
<span class="hljs-comment"> * Method:    say</span>
<span class="hljs-comment"> * Signature: ()V</span>
<span class="hljs-comment"> */</span>
<span class="hljs-function">JNIEXPORT <span class="hljs-keyword">void</span> JNICALL <span class="hljs-title">Java_Hello_say</span> <span class="hljs-params">(JNIEnv *, jobject)</span></span>;

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __cplusplus</span>
&#125;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></code></pre>

<p><strong>.h头文件名</strong>遵循格式:<code>Package_ClassName</code>,由于此处我们未创建包结构,因此Hello.java生成的.h文件名中省略了Package部分,即<code>Hello.h</code></p>
<p><strong>.h头文件方法名</strong>遵循格式<code>Java_{Package_ClassName}_{FunctionName}(JNI arguments)</code>比如<code>JNIEXPORT void JNICALL Java_Hello_say (JNIEnv *, jobject)</code>,</p>
<p><strong>jni.h</strong>是jdk中C语言库的头文件，在编译.c的时候需要指定jni.h的所在位置,否则会编译失败,在macOS中,其所在位置:<code>System/Library/Frameworks/JavaVM.framework/Headers</code>.</p>
<h2 id="编写C-C-文件"><a href="#编写C-C-文件" class="headerlink" title="编写C/C++文件"></a>编写C/C++文件</h2><p>有了.h头文件后,就可以为真正编写对应实现,这里创建了Hello.cpp,在方法输出Hello world.</p>
<pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Hello.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>

<span class="hljs-comment">/* 方法名需要和.h中声明的保持一致,不要弄错,否则会UnsatisfiedLinkError */</span>
JNIEXPORT <span class="hljs-keyword">void</span> JNICALL Java_Hello_say
  (JNIEnv *, jobject)&#123;
  	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Hello world!"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  &#125;</code></pre>


<h2 id="生成链接库"><a href="#生成链接库" class="headerlink" title="生成链接库"></a>生成链接库</h2><p>完成C/C++文件编写以后,通过以下命令将Hello.cpp编译成动态链接库.</p>
<pre><code class="hljs shell">g++ -fPIC -shared -o libhi.jnilib Hello.cpp -I/System/Library/Frameworks/JavaVM.framework/Headers</code></pre>
<ul>
<li>-fPIC : 要求编译器生成与位置无关的代码,否则会导致链接库在内存中无法被正确加载</li>
<li>-shared : 要求编译器生成共享链接库.使用该选项时必须指定-fPIC选项</li>
<li>-o : 该选项后需要指定动态链接库名字,需要保证其后缀名和运行平台对应,比如linux下是.so,mac下是.jnilib</li>
<li>-I : 该选项后需要指定jni.h文件所在的路径</li>
</ul>
<p><img src="https://i.imgur.com/eYe0HzY.png" srcset="/img/loading.gif" alt="image-20180829122221898"></p>
<p>接下来通过命令:<code>java Hello</code>运行主程序:</p>
<pre><code class="hljs java">Hello world!</code></pre>

<p>这里为了省事,我直接用g++来编译.</p>
<h1 id="JNI注意事项"><a href="#JNI注意事项" class="headerlink" title="JNI注意事项"></a>JNI注意事项</h1><p>在JNI开发过程中我们经常会遇到类问题:一是.h文件创建失败,另一类是调用过程,经常会遇到UnsatisfiedLinkError,</p>
<h2 id="h创建失败"><a href="#h创建失败" class="headerlink" title=".h创建失败"></a>.h创建失败</h2><p>在有些情况,通过javah创建.h文件时,可能会遇到错误:<code>Error: Could not find class file for &#39;XXX&#39;</code>.产生该问题的原因一般由于javah中路径指定有问题.在上述例子中由于我们Hello.java不存在包结构,因此在根目录下执行’javah Hello’会正常生成.h文件.但如果项目结构如下所示:</p>
<p><img src="https://i.imgur.com/LuHDXns.png" srcset="/img/loading.gif" alt="image-20180829133113486"></p>
<p>此时需要先进入src目录下,然后在该目录下执行如下命令:<code>javah -d jni com.lionoggo.Hello</code>即可,此处<code>-d</code>参数用来指定头文件存放路径.</p>
<p><img src="https://i.imgur.com/2mYpnI1.png" srcset="/img/loading.gif" alt="image-20180829133317779"></p>
<h2 id="UnsatisfiedLinkError"><a href="#UnsatisfiedLinkError" class="headerlink" title="UnsatisfiedLinkError"></a>UnsatisfiedLinkError</h2><p>该错误一般由于链接库路径不对或者链接库自身问题导致.</p>
<ol>
<li><p>链接库路径问题</p>
<p>如果链接库和主程序不在同一目录内,在执行时需要指定链接库路径,如下目录结构:</p>
<p><img src="https://i.imgur.com/KFscKtJ.png" srcset="/img/loading.gif" alt="image-20180829142537772"></p>
</li>
</ol>
<p>此时在执行主程序时需要指定路径:<code>java -Djava.library.path=./lib Hello</code></p>
<ol start="2">
<li><p>链接库本身</p>
<p>此处需要注意在macOS中动态链接库的后缀为jnilib,因此这里不要写成’g++ -fPIC -shared -o libhi.so …’,否则会导执行Java程序抛出以下错误:</p>
</li>
</ol>
<pre><code class="hljs java">Exception in thread <span class="hljs-string">"main"</span> java.lang.UnsatisfiedLinkError: no hi in java.library.path
	at java.lang.ClassLoader.loadLibrary(ClassLoader.java:<span class="hljs-number">1867</span>)
	at java.lang.Runtime.loadLibrary0(Runtime.java:<span class="hljs-number">870</span>)
	at java.lang.System.loadLibrary(System.java:<span class="hljs-number">1122</span>)
	at Hello.main(Hello.java:<span class="hljs-number">5</span>)</code></pre>


<h1 id="RegisterNatives解耦Native方法"><a href="#RegisterNatives解耦Native方法" class="headerlink" title="RegisterNatives解耦Native方法"></a>RegisterNatives解耦Native方法</h1><p>回过头来看上述Native的方法名:</p>
<pre><code class="hljs c++"><span class="hljs-function">JNIEXPORT <span class="hljs-keyword">void</span> JNICALL <span class="hljs-title">Java_Hello_say</span> <span class="hljs-params">(JNIEnv *, jobject)</span></span>;</code></pre>

<p>在没有包名的前提下,该方法看起来没什么问题,但是现在假设我们存在包名结构:<code>com.lionoggo.ireader</code>,那这个方法名就会变得很长:</p>
<pre><code class="hljs c++"><span class="hljs-function">JNIEXPORT <span class="hljs-keyword">void</span> JNICALL <span class="hljs-title">Java_com_lionoggo_ireader_Hello_say</span> <span class="hljs-params">(JNIEnv *, jobject)</span></span>;</code></pre>

<p>除此之外,每个方法都要带固定的<code>JNIEXPORT void JNICALL</code>,这就导致无法将Native方法名修改为更简洁的方式.JNI中提供了<code>RegisterNatives()</code>为Java中的Native方法动态绑定某个具体Native的实现方法.</p>
<h2 id="JNI-OnLoad-JNI-OnUnload"><a href="#JNI-OnLoad-JNI-OnUnload" class="headerlink" title="JNI_OnLoad/JNI_OnUnload"></a>JNI_OnLoad/JNI_OnUnload</h2><p>JNI组件被成功加载和卸载时,回回调响应的函数.当JVM执行执行<code>System.loadLibrary()</code>时会调用JNI组件的<code>JNI_ONLoad(JavaVm *vm,void *reserved)</code>,当VM释放JNI组件时会调用<code>JNI_OnUnload()</code>.</p>
<pre><code class="hljs c"><span class="hljs-comment">/* Defined by native libraries. */</span>
<span class="hljs-function">JNIEXPORT jint JNICALL <span class="hljs-title">JNI_OnLoad</span><span class="hljs-params">(JavaVM *vm, <span class="hljs-keyword">void</span> *reserved)</span></span>;
<span class="hljs-function">JNIEXPORT <span class="hljs-keyword">void</span> JNICALL <span class="hljs-title">JNI_OnUnload</span><span class="hljs-params">(JavaVM *vm, <span class="hljs-keyword">void</span> *reserved)</span></span>;</code></pre>

<p>要在JNI组件被加载时动态绑定Native方法,那么<code>JNI_OnLoad()</code>就是个非常好的时机,这里结合刚才提到的<code>RegisterNatives</code>来为Java中Native方法绑定具体的实现.</p>
<h2 id="RegisterNatives"><a href="#RegisterNatives" class="headerlink" title="RegisterNatives"></a>RegisterNatives</h2><pre><code class="hljs c"><span class="hljs-function">jint <span class="hljs-title">RegisterNatives</span><span class="hljs-params">(jclass clazz, <span class="hljs-keyword">const</span> JNINativeMethod* methods,</span></span>
<span class="hljs-function"><span class="hljs-params">        jint nMethods)</span></span></code></pre>

<p>该方法是JNI环境提供的用来注册Native方法的方法.期三个参数含义如下:</p>
<ul>
<li>clazz: Java Native类</li>
<li>methods: 用来注册的Native方法数组</li>
<li>nMethods: 用来注册的Native方法数目</li>
</ul>
<h2 id="JNINativeMethod"><a href="#JNINativeMethod" class="headerlink" title="JNINativeMethod"></a>JNINativeMethod</h2><p>JNINativeMethod是jni.h中定义的结构体,用来描述Native方法,macOS中可以在路径<code>System/Library/Frameworks/JavaVM.framework/Headers/jni.h</code>找到:</p>
<pre><code class="hljs c"><span class="hljs-comment">/*</span>
<span class="hljs-comment"> * used in RegisterNatives to describe native method name, signature,</span>
<span class="hljs-comment"> * and function pointer.</span>
<span class="hljs-comment"> */</span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>
    <span class="hljs-keyword">char</span> *name;       <span class="hljs-comment">// native方法名</span>
    <span class="hljs-keyword">char</span> *signature;  <span class="hljs-comment">// native方法签名</span>
    <span class="hljs-keyword">void</span> *fnPtr;      <span class="hljs-comment">// native函数指针</span>
&#125; JNINativeMethod;</code></pre>


<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><p>有了JNI_OnLoad和RegisterNatives后,我们就可以来实现Native方法的动态注册了,这里仍然之前的Hello.java作为演示,其过程相对固定,主要分为三步:</p>
<ol>
<li><p>根据需要实现相应的Native方法:</p>
<pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sayHello</span><span class="hljs-params">()</span></span>&#123;
   <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Hello world!"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
&#125;</code></pre>
</li>
<li><p>定义需要被绑定的本地方法.</p>
<pre><code class="hljs c"><span class="hljs-keyword">static</span> JNINativeMethod methods[] = &#123;
    <span class="hljs-comment">//java类native方法名|方法签名|Native实现方法名</span>
	&#123;<span class="hljs-string">"say"</span>,<span class="hljs-string">"()V"</span>,(<span class="hljs-keyword">void</span>*)sayHello&#125;,

&#125;;</code></pre>
</li>
<li><p>实现JNI_OnLoad方法,并使用RegisterNatives绑定java和native方法对应关系:</p>
<pre><code class="hljs c"><span class="hljs-function">JNIEXPORT jint <span class="hljs-title">JNI_OnLoad</span><span class="hljs-params">(JavaVM *vm, <span class="hljs-keyword">void</span> *reserved)</span></span>
<span class="hljs-function"></span>&#123;
    JNIEnv* env;

    <span class="hljs-comment">// 1.获取JNI环境对象</span>
    <span class="hljs-keyword">if</span> (JNI_OK != vm-&gt;GetEnv(<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">void</span>**&gt; (&amp;env),JNI_VERSION_1_4)) &#123;
        <span class="hljs-comment">//LOGW("JNI_OnLoad could not get JNI env");</span>
        <span class="hljs-keyword">return</span> JNI_ERR;
    &#125;

    <span class="hljs-comment">// 2.获取Java Native类</span>
    g_jvm = vm;
    jclass clazz = env-&gt;FindClass(classPathName);  <span class="hljs-comment">//获取Java NativeLib类</span>
    <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">NULL</span>) &#123;
        <span class="hljs-keyword">return</span> JNI_ERR;
    &#125;
    <span class="hljs-comment">// 3.调用RegisterNatives注册Native方法</span>
    <span class="hljs-keyword">if</span> (env-&gt;RegisterNatives(clazz, methods, <span class="hljs-keyword">sizeof</span>(methods)/<span class="hljs-keyword">sizeof</span>((methods)[<span class="hljs-number">0</span>])) &lt; <span class="hljs-number">0</span>) &#123;
        <span class="hljs-keyword">return</span> JNI_ERR;
    &#125;
    <span class="hljs-keyword">return</span> JNI_VERSION_1_4;
&#125;</code></pre>

</li>
</ol>
<p>经过以上三部,就可以实现动态绑定Native方法了.HelloRegister.cpp的完整代码如下:</p>
<pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;jni.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>

JavaVM* g_jvm;

<span class="hljs-comment">// Method define start</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sayHello</span><span class="hljs-params">()</span></span>&#123;
   <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Hello world!"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
&#125;
<span class="hljs-comment">// Method define end</span>

<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * classPathName = <span class="hljs-string">"com/lionoggo/Hello"</span>;


<span class="hljs-keyword">static</span> JNINativeMethod methods[] = &#123;
    <span class="hljs-comment">//java类native方法名|方法签名|Native实现方法名</span>
	&#123;<span class="hljs-string">"say"</span>,<span class="hljs-string">"()V"</span>,(<span class="hljs-keyword">void</span>*)sayHello&#125;,

&#125;;

<span class="hljs-function">JNIEXPORT jint <span class="hljs-title">JNI_OnLoad</span><span class="hljs-params">(JavaVM *vm, <span class="hljs-keyword">void</span> *reserved)</span></span>
<span class="hljs-function"></span>&#123;
    JNIEnv* env;
    <span class="hljs-comment">// 1.获取JNI环境对象</span>
    <span class="hljs-keyword">if</span> (JNI_OK != vm-&gt;GetEnv(<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">void</span>**&gt; (&amp;env),JNI_VERSION_1_4)) &#123;
        <span class="hljs-comment">//LOGW("JNI_OnLoad could not get JNI env");</span>
        <span class="hljs-keyword">return</span> JNI_ERR;
    &#125;
    g_jvm = vm;
    <span class="hljs-comment">// 2.获取Java Native类</span>
    jclass clazz = env-&gt;FindClass(classPathName);
    <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">NULL</span>) &#123;
        <span class="hljs-keyword">return</span> JNI_ERR;
    &#125;
    <span class="hljs-comment">// 3.调用RegisterNatives注册Native方法</span>
    <span class="hljs-keyword">if</span> (env-&gt;RegisterNatives(clazz, methods, <span class="hljs-keyword">sizeof</span>(methods)/<span class="hljs-keyword">sizeof</span>((methods)[<span class="hljs-number">0</span>])) &lt; <span class="hljs-number">0</span>) &#123;
        <span class="hljs-keyword">return</span> JNI_ERR;
    &#125;
    <span class="hljs-keyword">return</span> JNI_VERSION_1_4;
&#125;</code></pre>

<p>将其打包成本地链接库libhi.jnilib,然后像之前一样执行Hello.java即可.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>RegisterNatives除了能解决原来JNI中方法遵循特定方法命名规则外,还具备以下两个优点:</p>
<ul>
<li><p>VM查找Native效率的提高</p>
<p>在调用Native方法时,VM需要多次在本地链接库中进行查找,多次调用就会产生多次查找.而通过RegisterNatives注册后,VM的查找次数会减少.</p>
</li>
<li><p>在执行期间进行Native方法的替换.</p>
<p>在methods通过函数指针来绑定方法,这意味着我们可以在运行期间多次调用RegisterNatives来实现Native方法的替换.</p>
</li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www3.ntu.edu.sg/home/ehchua/programming/java/JavaNativeInterface.html" target="_blank" rel="noopener">Java Native Interface</a></p>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/technology/">technology</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/JNI/">JNI</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2016/12/25/%E7%8E%A9%E8%BD%AC%E6%B3%A8%E8%A7%A3%E4%B9%8B%E5%9F%BA%E7%A1%80%E7%AF%87/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">玩转注解之基础篇</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2016/12/15/Android%E6%9D%82%E8%B0%88:%E4%BB%8E%E6%A8%A1%E5%9D%97%E5%8C%96%E5%88%B0%E7%BB%84%E4%BB%B6%E5%8C%96/">
                        <span class="hidden-mobile">Android杂谈:从模块化到组件化</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/main.js" ></script>


  <script  src="/js/lazyload.js" ></script>



  
  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>





  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>






<!-- Plugins -->



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "JNI开发之RegisterNatives&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>


















<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"right","width":75,"height":150},"mobile":{"show":true}});</script></body>
</html>
